<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-item/core-item.html">
<link rel="import" href="octopus-blockly-toolbox/octopus-blockly-toolbox.html">
<link rel="import" href="octopus-blockly-code/octopus-blockly-code.html">

<script type="text/javascript" src="dist/blockly.js"></script>
<script type="text/javascript" src="overrides.js"></script>
<script type="text/javascript" src="contextmenu.js"></script>

<script type="text/javascript" src="ext/colourscheme.js"></script>

<script type="text/javascript" src="msg/messages.js"></script>

<script type="text/javascript" src="dist/blocks.js"></script>
<script type="text/javascript" src="dist/python-octo.js"></script>

<polymer-element name="octopus-editor" attributes="toolbox code">
<template>

<link rel="stylesheet" href="blockly.css">
<link rel="stylesheet" href="ext.css">
<style>

:host {
	flex: 1;
	display: flex;
	flex-direction: column;
	height: 100vh;
}

:host octopus-blockly-toolbox {
	margin: 12px 0;
	width: 180px;
}

:host octopus-blockly-toolbox core-item {
	padding: 0 10px;
}

:host octopus-blockly-toolbox core-item.core-selected {
	background: #E2E2E2;
}

:host octopus-blockly-code {
	width: 400px;
}

:host #blockly {
	position:relative;
}

:host #blockly svg {
	position: absolute;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
}

</style>

<div horizontal layout flex>
	<octopus-blockly-toolbox valueattr="name" selected="{{ toolboxSelected }}" on-activate="{{ toolboxActivate }}" on-deactivate="{{ toolboxDeactivate }}" >
		<template repeat="{{ category, i in toolbox }}">
			<core-item icon="{{ category.icon }}" name="category-{{ i }}" label="{{ category.name }}"></core-item>
		</template>
	</octopus-blockly-toolbox>
	<div id="blockly" flex></div>
	<octopus-blockly-code code="{{ code }}"></octopus-blockly-code>
</div>


<xml id="toolboxCategories" style="display: none">
    <category name="Machines">
      <block type="machine_vapourtec_R2R4"></block>
      <block type="machine_knauer_K120"></block>
      <block type="machine_knauer_S100"></block>
      <block type="machine_vici_multivalve"></block>
      <block type="machine_mt_icir"></block>
      <block type="connection_tcp"></block>
      <block type="connection_serial"></block>
	</category>
	<category name="Control">
      <block type="controls_wait"></block>
      <block type="controls_wait_until"></block>
      <block type="controls_if"></block>
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_parallel"></block>
      <block type="controls_dependents"></block>
      <block type="controls_bind"></block>
      <block type="controls_statemonitor"></block>
      <!--block type="controls_run"></block-->
    </category>
    <category name="Logic">
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>
    </category>
    <category name="Images">
      <block type="machine_imageprovider"></block>
      <block type="machine_singletracker"></block>
      <block type="machine_multitracker"></block>
      <block type="connection_cvcamera"></block>
      <block type="image_findcolour"></block>
      <block type="image_threshold"></block>
      <block type="image_erode"></block>
      <block type="image_tonumber"></block>
    </category>
    <category name="Math">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_trig"></block>
      <block type="math_constant"></block>
      <block type="math_number_property"></block>
      <block type="math_change"></block>
      <block type="math_round"></block>
      <block type="math_on_list"></block>
      <block type="math_modulo"></block>
      <block type="math_constrain">
        <value name="LOW">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <value name="HIGH">
          <block type="math_number">
            <field name="NUM">100</field>
          </block>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <value name="TO">
          <block type="math_number">
            <field name="NUM">100</field>
          </block>
        </value>
      </block>
      <block type="math_random_float"></block>
      <block type="math_framed"></block>
    </category>
    <category name="Text">
      <block type="text"></block>
      <block type="text_join"></block>
      <block type="controls_log"></block>
      <!--block type="text_append">
        <value name="TEXT">
          <block type="text"></block>
        </value>
      </block>
      <block type="text_length"></block>
      <block type="text_isEmpty"></block>
      <block type="text_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">text</field>
          </block>
        </value>
      </block>
      <block type="text_charAt">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">text</field>
          </block>
        </value>
      </block>
      <block type="text_getSubstring">
        <value name="STRING">
          <block type="variables_get">
            <field name="VAR">text</field>
          </block>
        </value>
      </block>
      <block type="text_changeCase"></block>
      <block type="text_trim"></block-->
    </category>
    <!--category name="Lists">
      <block type="lists_create_empty"></block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM">
          <block type="math_number">
            <field name="NUM">5</field>
          </block>
        </value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">list</field>
          </block>
        </value>
      </block>
      <block type="lists_getIndex">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">list</field>
          </block>
        </value>
      </block>
      <block type="lists_setIndex">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">list</field>
          </block>
        </value>
      </block>
      <block type="lists_getSublist">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">list</field>
          </block>
        </value>
      </block>
    </category-->
    <!--category name="Variables" custom="VARIABLE"></category-->
    <category name="Variables">
      <block type="global_declaration"></block>
      <block type="lexical_variable_set"></block>
      <block type="lexical_variable_get"></block>
	</category>
    <!--category name="Functions" custom="PROCEDURE"></category-->
  </xml>
  
</template>
<script> 

Polymer('octopus-editor', {
	ready: function () {
		Blockly.inject(this.$.blockly, {
			path: '/components/octopus-editor/'
		});

		this.loaded = false;

		this.toolboxPopulate(this.$.toolboxCategories);
		Blockly.addChangeListener(this.blocklyChanged.bind(this));
		Blockly.on("hide-toolbox", this.toolboxClosed.bind(this));

	},

	blocklyChanged: function () {
		this.code = Blockly.PythonOcto.workspaceToCode();
	},

	// Received initial load data from the server
	loadSketch: function (sketch) {
		var workspace = Blockly.mainWorkspace;
		var moveBlocks = {};

		var event, data;
		for (var i in sketch.events) {
			event = sketch.events[i];
			data = event.data;
			if (event.type === "AddBlock") {
				var block = Blockly.Block.obtain(workspace, data.type, data.id);

				for (var field in data.fields) {
					block.setFieldValue(data.fields[field], field);
				}

				block.initSvg();

			} else if (event.type === "SetBlockPosition") {
				var block = workspace.getBlockById(data.id);
				block.moveTo(data.x, data.y);

			} else if (event.type === "SetBlockInputsInline") {
				var block = workspace.getBlockById(data.id);
				block.setInputsInline(data.value);

			} else if (event.type === "SetBlockDisabled") {
				var block = workspace.getBlockById(data.id);
				block.setDisabled(data.value);

			} else if (event.type === "SetBlockCollapsed") {
				var block = workspace.getBlockById(data.id);
				block.setCollapsed(data.value);

			} else if (event.type === "SetBlockComment") {
				var block = workspace.getBlockById(data.id);
				block.setCommentText(data.value);

			} else if (event.type === "SetBlockMutation") {
				var block = workspace.getBlockById(data.id);
				block.JSONToMutation(JSON.parse(data.mutation));

			} else if (event.type === "ConnectBlock") {
				var block = workspace.getBlockById(data.id);
				var parent = workspace.getBlockById(data.parent);

				if (data.connection === "input-value") {
					var input = parent.getInput(data.input);
					if (input) {
						input.connection.connect(block.outputConnection);
					}
				} else if (data.connection === "input-statement") {
					var input = parent.getInput(data.input);
					if (input) {
						input.connection.connect(block.previousConnection);
					}
				} else if (data.connection === "previous") {
					parent.nextConnection.connect(block.previousConnection);
				}
			}
		}

		// Force re-evaluation of variable names upon loading.
		var topBlocks = Blockly.mainWorkspace.getTopBlocks();
		for (var i = 0, m = topBlocks.length; i < m; i++) {
			topBlocks[i].setParent(null);
		}

		workspace.render();

		// Set block running states
		var states = sketch['block-states'];
		for (var id in states) {
			workspace.getBlockById(id).setRunningState(states[id]);
		}

		var blockEvents = [
			"created", "disposed", "connected", "disconnected",
			"set-position", "set-field-value", "set-disabled", 
			"set-inputs-inline", "add-input", "remove-input",
			"set-comment", "set-collapsed",
			"set-mutation", "transaction"
		];
		var editor = this;
		blockEvents.forEach(function (type) {
			Blockly.on("block-" + type, function (detail) {
				editor.fire("block-event", {
					eventType: type,
					data: detail
				});
			});
		});
	},

	blockChanged: function (command, payload) {
		var workspace = Blockly.mainWorkspace;

		if (command === "transaction") {
			return console.log("transaction", payload);
		}
		if (command === "created") {
			workspace.startEmitTransaction();

			var block = Blockly.Block.obtain(workspace, payload.type, payload.id);
			block.initSvg();
			block.render();

			block.moveBy(payload.x, payload.y);

			for (var field in payload.fields) {
				block.setFieldValue(payload.fields[field], field);
			}

			workspace.discardEmitTransaction();
			return;
		}
		if (command === "state") {
			var block = workspace.getBlockById(payload.block);
			if (block) {
				return block.setRunningState(payload.state);
			}
		}

		var block = workspace.getBlockById(payload.id);
		if (!block) {
			return;
		}

		workspace.startEmitTransaction();
		switch (command) {
			case "set-position":
				block.moveTo(payload.x, payload.y);
				break;
			case "set-field-value":
				block.setFieldValue(payload.value, payload.field);
				break;
			case "set-disabled":
				block.setDisabled(payload.value);
				break;
			case "set-inputs-inline":
				block.setInputsInline(payload.value);
				break;
			case "set-collapsed":
				block.setCollapsed(payload.value);
				break;
			case "set-comment":
				block.setCommentText(payload.value);
				break;
			case "set-mutation":
				block.JSONToMutation(JSON.parse(payload.mutation));
				break;
			case "disposed":
				block.dispose();
				break;
			case "connected":
				var parent = workspace.getBlockById(payload.parent);
				if (payload.connection === "input-value") {
					parent.getInput(payload.input).connection.connect(block.outputConnection);
					break;
				}
				if (payload.connection === "input-statement") {
					parent.getInput(payload.input).connection.connect(block.previousConnection);
					break;
				}
				if (payload.connection === "previous") {
					parent.nextConnection.connect(block.previousConnection);
					break;
				}
			case "disconnected":
				var connection, parentConnection;
				if (payload.connection === "input-value") {
					connection = block.outputConnection;
				} else if (payload.connection === "input-statement") {
					connection = block.previousConnection;
				} else if (payload.connection === "previous") {
					connection = block.previousConnection;
				}
				parentConnection = connection.targetConnection;
				block.setParent(null);
				connection.bumpAwayFrom_(parentConnection);
				break;
		}

		workspace.discardEmitTransaction();
	},

	clearBlockStates: function () {
		Blockly.mainWorkspace.getAllBlocks().forEach(function (block) {
			block.setRunningState("ready");
		});
	},

	toolboxPopulate: function (xml) {
		// Iterate over each category.
		var toolbox = [];

		function filterChildNodesByTag (node, name) { 
			return node.childNodes.array().filter(function (node) { 
				return node.tagName && node.tagName.toLowerCase() == name; 
			});
		}
		var nodes = filterChildNodesByTag(xml, 'category');

		nodes.forEach(function (node) {
			var custom = node.getAttribute('custom');

			toolbox.push ({
				name: node.getAttribute('name'),
				icon: node.getAttribute('icon') || 'settings',
				blocks: custom ? custom : filterChildNodesByTag(node, 'block')
			});
		})

		this.toolbox = toolbox;
	},

	toolboxActivate: function (ev, detail) {
		//try {
			var category, s = detail.value.split("-");
			if (s.length == 2 && s[0] == "category") {
				category = this.toolbox[parseInt(s[1])];
				Blockly.Toolbox.flyout_.show(category.blocks);
			}
		//} catch (e) {}
	},
	toolboxDeactivate: function () {
		// If the toolbar is closed by deselecting the menu, tell
		// Blockly to close the flyout menu.
		Blockly.Toolbox.flyout_.hide();
	},
	toolboxClosed: function () {
		// If the toolbar is closed by Blockly (e.g. by clicking in the svg area)
		// deselect the menu item.
		this.toolboxSelected = null;
	}
});

</script>
</polymer-element>
