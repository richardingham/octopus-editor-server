<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-splitter/core-splitter.html">

<link rel="import" href="../../components/octopus-chart/octopus-chart.html">

<polymer-element name="octopus-experiment-interface" attributes="variables runtimeProperties runtimeStreams">
<template>
<style>

:host {
	display: flex;
	flex-direction: row;
	flex: 1;
}

variables-list {
	overflow-y: scroll;
}

variables-list ol {
	list-style-type: none;
	margin: 13px 0;
	padding: 0;
}

variables-list ol li {
	padding: 2px 15px;
	cursor: pointer;
}

experiment-data {
	flex: 1;
	overflow-y: scroll;
}

experiment-data octopus-chart {
	display: block;
}

experiment-data octopus-property {
	background-color: #526E9C;
	color: #FFF;
	border-radius: 2px;
	display: inline;
	margin: 5px;
	padding: 5px;
	float: left;
}

experiment-data .over {
	border: 2px solid black;
}

experiment-data .slot {
	display: none;
	background: #none;
	border: 2px dashed #555;
	width: 90%;
	margin: 10px;
	height: 15px;
}

experiment-data .slot.over {
	border: 2px dashed #000;
	background-color: #DFDFDF;
}

experiment-data.dragging .slot {
	display: block;
}

</style>

<variables-list on-click="{{ variableClicked }}">
	<ol>
	<template repeat="{{ variables as v }}">
		<li data-id="{{ v.key }}">{{ v.name }}</li>
	</template>
	</ol>
</variables-list>

<core-splitter direction="left" allowOverflow="true"></core-splitter>

<experiment-data id="displayarea" on-dragstart="{{ dragStart }}" on-dragend="{{ dragEnd }}">
	<template repeat="{{ g in graphs }}">

	<div class="slot" data-before="{{ g.index }}"
		on-dragover="{{ dragOverSlot }}"
		on-dragenter="{{ dragEnterSlot }}"
		on-dragleave="{{ dragLeaveSlot }}"
		on-drop="{{ dropOnSlot }}"
	></div>

	<octopus-chart 
		data-index="{{ g.index }}"
		streams="{{ g.streams }}"
		timezero="{{ timeZero }}"
		draggable="true"
		on-dragover="{{ dragOverChart }}"
		on-dragenter="{{ dragEnterChart }}"
		on-dragleave="{{ dragLeaveChart }}"
		on-drop="{{ dropOnChart }}"
		on-remove-chart="{{ removeChart }}"
	>
	</octopus-chart>
	</template>

	<template repeat="{{ p in properties }}">
	<octopus-property data-name="{{ p.key }}" 
		draggable="true"
		on-dragover="{{ dragOverProperty }}" 
		on-dragenter="{{ dragEnterProperty }}" 
		on-dragleave="{{ dragLeaveProperty }}"
		on-drop="{{ dropOnProperty }}"
	>
		<span class="close" on-click="{{ propertyRemove }}">X</span>
		<template if="{{ p.type === 'int' || p.type === 'float' }}">
			<span class="graph" on-click="{{ propertyGraph }}">G</span>
		</template>
		<template if="{{ p.edit }}">
			<span class="edit" on-click="{{ propertyEdit }}">E</span>
		</template>
		<span class="name">{{ p.name }}</span>
		<span class="value">{{ p.value }}</span>
	</octopus-property>
	</template>
</experiment-data>

</template>
<script>

Polymer('octopus-experiment-interface', {

	timeZero: 0,
	variables: [],
	runtimeProperties: [],
	runtimeStreams: [],

	properties: [],
	graphs: [],

	_itemIndex: 0,

	_dragEnterCount: 0,
	_dragSourceName: null,
	_dragSourceType: null,
	_dragSourceIndex: null,

	variableClicked: function (e) {
		if (e.srcElement.dataset.id) {
			var id = e.srcElement.dataset.id;

			// Check not already in properties.
			for (var i = 0, m = this.properties.length; i < m; i++) {
				if (this.properties[i].key === id) {
					return;
				}
			}

			// Find id in variables.
			for (var i = 0, m = this.variables.length; i < m; i++) {
				if (this.variables[i].key === id) {
					var variable = this.variables[i];
					variable.value = null;
					this.properties.push(variable);
					this.runtimeProperties.push(id);
					return;
				}
			}
		}
	},

	onPropertiesData: function (data) {
		this.properties.forEach(function (property) {
			if (typeof data[property.key] !== "undefined") {
				property.value = data[property.key];
			}
		});
	},

	propertyRemove: function (e) {
		var id = e.srcElement.parentElement.dataset.name;

		// Remove id from runtime properties.
		for (var i = 0, m = this.runtimeProperties.length; i < m; i++) {
			if (this.runtimeProperties[i] === id) {
				this.runtimeProperties.splice(i, 1);
				break;
			}
		}

		// Remove id from properties.
		for (var i = 0, m = this.properties.length; i < m; i++) {
			if (this.properties[i].key === id) {
				return this.properties.splice(i, 1);
			}
		}
	},

	propertyGraph: function (e) {
		var property = this.propertyRemove(e);

		if (property) {
			this.graphs.push({
				index: this._itemIndex++,
				streams: property,
				unit: property[0].unit
			});

			this.runtimeStreams.push(property[0].key);
		}
	},

	onStreamData: function (data) {
		var charts = this.$.displayarea.getElementsByTagName('octopus-chart');
		for (var i = 0, m = charts.length; i < m; i++) {
			charts[i].addData(data);
		};
	},
	
	dragStart: function (e) {
		var id, arr, propName;

		if (e.target.tagName === "OCTOPUS-PROPERTY") {
			id = e.target.dataset.name;
			arr = this.properties;
			propName = "key";

			this._dragSourceType = "property";
			this._dragSourceName = id;

		} else if (e.target.tagName === "OCTOPUS-CHART") {
			id = parseInt(e.target.dataset.index, 10);
			arr = this.graphs;
			propName = "index";

			this._dragSourceType = "chart";
			this._dragSourceName = id;

		} else {
			return;
		}

		for (var i = 0, m = arr.length; i < m; i++) {
			if (arr[i][propName] === id) {
				this._dragSourceIndex = i;
				break;
			}
		}

		// Set Dragging classes - NB due to chrome bug DOM modification
		// cannot be performed directly in dragStart.
		var target = e.target;
		var area = this.$.displayarea;
		window.setTimeout(function () {
			$(target).addClass("dragging");
			$(area).addClass("dragging");
		}, 0);
	},

	dragOverProperty: function (e) {
		//console.log("over", e.target);
		var id = e.target.dataset.name;

		if (this._dragSourceType === "chart") {
			e.dataTransfer.dropEffect = 'none'; 
			return;
		}

		var target = this._targetAncestor(e.target, "octopus-property");

		if (this._dragEnterCount > 0 && $(target).data("name") !== this.properties[this._dragSourceIndex].key) {
			e.dataTransfer.dropEffect = 'move'; 
			//console.log("over:", id, this._dragSourceName);
			e.preventDefault();
			return false;
		}
	},

	_targetAncestor: function (target, tag) {
		if (target.tagName.toLowerCase() === tag) {
			return $(target);
		} else {
			return $(target).parents(tag);
		}
	},

	dragEnterProperty: function (e) {
		if (this._dragSourceType === "chart") {
			return;
		}

		var target = this._targetAncestor(e.target, "octopus-property");

		if (target.hasClass("dragging") || $(target).data("name") === this.properties[this._dragSourceIndex].key) {
			return;
		}

		if (this._dragEnterCount === 0) {
			$("octopus-chart, octopus-property", this.$.displayarea).removeClass("over");
			target.addClass("over");
		}
		this._dragEnterCount++;
	},

	dragLeaveProperty: function (e) {
		if (this._dragSourceType === "chart") {
			return;
		}

		var target = this._targetAncestor(e.target, "octopus-property");

		if (this._dragEnterCount > 0 && --this._dragEnterCount === 0) {
			$("octopus-chart, octopus-property", this.$.displayarea).removeClass("over");
		}
	},

	dropOnProperty: function (e) {
		if (this._dragSourceType === "property") {
			var i, m, name = e.currentTarget.dataset.name;

			for (i = 0, m = this.properties.length; i < m; i++) {
				if (this.properties[i].key === name) {
					break;
				}
			}

			if (i < m) {
				var sourceProp = this.properties.splice(this._dragSourceIndex, 1)[0];
				this.properties.splice(i, 0, sourceProp);
			}
		}
	},

	dragEnd: function () {
		this._dragEnterCount = 0;
		$(".dragging", this.$.displayarea).removeClass("dragging");
		$(this.$.displayarea).removeClass("dragging");
		$("octopus-chart, octopus-property", this.$.displayarea).removeClass("over");

		this._dragSourceType = null;
		this._dragSourceName = null;
		this._dragSourceIndex = null;
	},

	_validOverChart: function (target) {
		if (!target) {
			return false;
		}
		if (this._dragSourceType === "property") {
			return this.properties[this._dragSourceIndex].unit === target.unit;
		}
		if (this._dragSourceType === "chart") {
			return this.graphs[this._dragSourceIndex].unit === target.unit && $(target).data("index") !== this._dragSourceName;
		}
		return false;
	},

	dragOverChart: function (e) {
		var target = this._targetAncestor(e.target, "octopus-chart");

		if (this._validOverChart(target[0])) {
			e.dataTransfer.dropEffect = 'move'; 
			e.preventDefault();
			return;
		}

		if (this._dragEnterCount > 0) {
			e.dataTransfer.dropEffect = 'move'; 
			//console.log("over:", id, this._dragSourceName);
			e.preventDefault();
			return false;
		}
	},
	
	dragEnterChart: function (e) {
		var target = this._targetAncestor(e.target, "octopus-chart");

		if (!this._validOverChart(target[0])) {
			return;
		}

		if (this._dragEnterCount === 0) {
			$(target).addClass("over");
		}
		this._dragEnterCount++;
	},

	dragLeaveChart: function (e) {
		if (this._dragEnterCount > 0 && --this._dragEnterCount === 0) {
			var target = this._targetAncestor(e.target, "octopus-chart");
			$(target).removeClass("over");
		}
	},

	dropOnChart: function (e) {
		var target = this._targetAncestor(e.target, "octopus-chart");

		// Combine streams of source chart with target chart
		if (this._dragSourceType === "chart") {
			var index = parseInt(target.data("index"), 10);

			if (index === this._dragSourceName) {
				return;
			}

			var chart = this.graphs[this._dragSourceIndex];
			Array.prototype.push.apply(target[0].streams, chart.streams);
			this.graphs.splice(this._dragSourceIndex, 1);
		}

		// Add source property to target chart.
		if (this._dragSourceType === "property") {
			var property = this.properties[this._dragSourceIndex];
			this.runtimeStreams.push(property.key);
			target[0].streams.push(property);
			this.properties.splice(this._dragSourceIndex, 1);
		}
	},

	dragOverSlot: function (e) {
		var target = this._targetAncestor(e.target, "div");

		if (this._dragSourceType === "chart") {
			e.dataTransfer.dropEffect = 'move'; 
			e.preventDefault();
			return;
		}
	},

	dragEnterSlot: function (e) {
		var target = this._targetAncestor(e.target, "div");

		if (this._dragSourceType !== "chart") {
			return;
		}

		if (this._dragEnterCount === 0) {
			$(target).addClass("over");
		}
		this._dragEnterCount++;
	},

	dragLeaveSlot: function (e) {
		if (this._dragEnterCount > 0 && --this._dragEnterCount === 0) {
			var target = this._targetAncestor(e.target, "div");
			$(target).removeClass("over");
		}
	},

	dropOnSlot: function (e) {
		var i, m, index = parseInt(this._targetAncestor(e.target, "div").data("before"), 10);

		for (i = 0, m = this.graphs.length; i < m; i++) {
			if (this.graphs[i].index === index) {
				break;
			}
		}

		if (this._dragSourceType === "chart") {
			var chart = this.graphs.splice(this._dragSourceIndex, 1);
			this.graphs.splice(i, 0, chart[0]);
		}
	},

	removeChart: function (e) {
		var index = $(e.target).data("index");

		for (i = 0, m = this.graphs.length; i < m; i++) {
			if (this.graphs[i].index === index) {
				this.graphs.splice(i, 1);
				break;
			}
		}
	},
});

</script>
</polymer-element>
