<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-splitter/core-splitter.html">

<link rel="import" href="../../components/octopus-chart/octopus-chart.html">

<polymer-element name="octopus-experiment-interface" attributes="variables runtimeProperties runtimeStreams">
<template>
<style>

:host {
	display: flex;
	flex-direction: row;
	flex: 1;
}

variables-list {
	overflow-y: scroll;
}

variables-list ol {
	list-style-type: none;
	margin: 13px 0;
	padding: 0;
}

variables-list ol li {
	padding: 2px 15px;
	cursor: pointer;
}

experiment-data .property {
	flex: 1;
	background-color: #526E9C;
	color: #FFF;
	border-radius: 2px;
	display: inline;
	margin: 5px;
	padding: 5px;
	float: left;
	position: relative;
}

experiment-data .over {
	border: 2px solid black;
}

</style>

<variables-list on-click="{{ variableClicked }}">
	<ol>
	<template repeat="{{ variables as v }}">
		<li data-id="{{ v.name }}">{{ v.name }}</li>
	</template>
	</ol>
</variables-list>

<core-splitter direction="left" allowOverflow="true"></core-splitter>

<experiment-data id="displayarea" on-dragstart="{{ dragStart }}">
	<template repeat="{{ g in graphs }}">
	<octopus-chart 
		streams="{{ g.streams }}"
		timezero="{{ timeZero }}"
		draggable="true"
		on-dragover="{{ dragOver }}"
		on-dragenter="{{ dragEnter }}"
		on-dragleave="{{ dragLeave }}"
		on-drop="{{ drop }}"
	>
	</octopus-chart>
	</template>

	<template repeat="{{ p in properties }}">
	<div class="property" data-name="{{ p.name }}" 
		draggable="true"
		on-dragover="{{ dragOver }}" 
		on-dragenter="{{ dragEnter }}" 
		on-dragleave="{{ dragLeave }}"
		on-drop="{{ drop }}"
	>
		<span class="close" on-click="{{ propertyRemove }}">X</span>
		<template if="{{ p.type === 'int' || p.type === 'float' }}">
			<span class="graph" on-click="{{ propertyGraph }}">G</span>
		</template>
		<template if="{{ p.edit }}">
			<span class="edit" on-click="{{ propertyEdit }}">E</span>
		</template>
		<span class="name">{{ p.name }}</span>
		<span class="value">{{ p.value }}</span>
	</div>
	</template>
</experiment-data>

</template>
<script>

Polymer('octopus-experiment-interface', {

	timeZero: 0,
	variables: [],
	runtimeProperties: [],
	runtimeStreams: [],

	properties: [],
	graphs: [],

	_dragEnterCount: 0,
	_dragSourceName: null,
	_dragSourceType: null,
	_dragSourceIndex: null,

	variableClicked: function (e) {
		if (e.srcElement.dataset.id) {
			var id = e.srcElement.dataset.id;

			// Check not already in properties.
			for (var i = 0, m = this.properties.length; i < m; i++) {
				if (this.properties[i].name === id) {
					return;
				}
			}

			// Find id in variables.
			for (var i = 0, m = this.variables.length; i < m; i++) {
				if (this.variables[i].name === id) {
					var variable = this.variables[i];
					variable.value = null;
					this.properties.push(variable);
					this.runtimeProperties.push(id);
					return;
				}
			}
		}
	},

	onPropertiesData: function (data) {
		this.properties.forEach(function (property) {
			if (typeof data[property.name] !== "undefined") {
				property.value = data[property.name];
			}
		});
	},

	propertyRemove: function (e) {
		var id = e.srcElement.parentElement.dataset.name;

		// Remove id from runtime properties.
		for (var i = 0, m = this.runtimeProperties.length; i < m; i++) {
			if (this.runtimeProperties[i] === id) {
				this.runtimeProperties.splice(i, 1);
				break;
			}
		}

		// Remove id from properties.
		for (var i = 0, m = this.properties.length; i < m; i++) {
			if (this.properties[i].name === id) {
				return this.properties.splice(i, 1);
			}
		}
	},

	propertyGraph: function (e) {
		var property = this.propertyRemove(e);

		if (property) {
			this.graphs.push({
				streams: property,
				unit: property[0].unit
			});

			this.runtimeStreams.push(property[0].name);
		}
	},

	onStreamData: function (data, zero) {
		var charts = this.$.displayarea.getElementsByTagName('octopus-chart');
		for (var i = 0, m = charts.length; i < m; i++) {
			charts[i].addData(data, zero);
		};
	},

	dragStart: function (e) {
		//console.log("start", e, e.target);

		this._dragSourceType = e.target.tagName === "DIV" ? "property" : "graph";
		
		var id = e.target.dataset.name;
		this._dragSourceName = id;
		for (var i = 0, m = this.properties.length; i < m; i++) {
			if (this.properties[i].name === id) {
				this._dragSourceIndex = i;
				break;
			}
		}
	},
	
	dragOver: function (e) {
		//console.log("over", e.target);
		var id = e.target.dataset.name;

		if (this._dragEnterCount > 0 || (id && id !== this._dragSourceName)) {
			e.dataTransfer.dropEffect = 'move'; 
			//console.log("over:", id, this._dragSourceName);
			e.preventDefault();
			return false;
		}
	},
	
	dragEnter: function (e) {
		//console.log("enter");

		var id = e.target.dataset.name;

		if (this._dragEnterCount === 0) {
			if (!(id && id !== this._dragSourceName)) {
				return;
			}
			$(e.target).addClass("over");
		}
		this._dragEnterCount++;
	},
	
	dragLeave: function (e) {
		//console.log("leave", e, element);

		var id = e.target.dataset.name;
		
		//if (!(id && id !== this._dragSourceName)) {
		//	return;
		//}

		if (this._dragEnterCount > 0 && --this._dragEnterCount === 0) {
			
			$(e.target).removeClass("over");
		}
	},
	
	drop: function (e) {
		console.log("drop");
		this._dragEnterCount = 0;
		$(e.currentTarget).removeClass("over");

		if (this._dragSourceType === "property") {
			var i, m, name = e.currentTarget.dataset.name;

			for (i = 0, m = this.properties.length; i < m; i++) {
				if (this.properties[i].name === name) {
					break;
				}
			}
			if (i < m) {
				var sourceProp = this.properties.splice(this._dragSourceIndex, 1)[0];
				this.properties.splice(i, 0, sourceProp);
			}
		}

		this._dragSourceType = null;
		this._dragSourceName = null;
		this._dragSourceIndex = null;
	}
});

</script>
</polymer-element>
