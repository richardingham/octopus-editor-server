<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-splitter/core-splitter.html">

<link rel="import" href="../../components/octopus-chart/octopus-chart-static.html">

<polymer-element name="octopus-experiment-viewer" attributes="variables dataurl">
<template>
<style>

variables-list {
	overflow-y: scroll;
}

variables-list ol {
	list-style-type: none;
	margin: 13px 0;
	padding: 0;
}

variables-list ol li {
	padding: 2px 15px;
	cursor: pointer;
}
variables-list ol li:hover {
	color: #FFF;
	background-color: #526E9C;
}

experiment-data {
	flex: 1;
	overflow-y: scroll;
}

experiment-data octopus-chart-static {
	display: block;
}

experiment-data .over {
	border: 2px solid black;
}

experiment-data .slot {
	display: none;
	background: #none;
	border: 2px dashed #555;
	width: 90%;
	margin: 10px;
	height: 15px;
}

experiment-data .slot.over {
	border: 2px dashed #000;
	background-color: #DFDFDF;
}

experiment-data.dragging .slot {
	display: block;
}

</style>

<variables-list on-click="{{ variableClicked }}">
	<ol>
	<template repeat="{{ variables as v }}">
		<li data-id="{{ v.key }}">{{ v.name }}</li>
	</template>
	</ol>
</variables-list>

<core-splitter direction="left" allowOverflow="true"></core-splitter>

<experiment-data id="displayarea" on-dragstart="{{ dragStart }}" on-dragend="{{ dragEnd }}">
	<template repeat="{{ g in graphs }}">

	<div class="slot" data-before="{{ g.index }}"
		on-dragover="{{ dragOverSlot }}"
		on-dragenter="{{ dragEnterSlot }}"
		on-dragleave="{{ dragLeaveSlot }}"
		on-drop="{{ dropOnSlot }}"
	></div>

	<octopus-chart-static
		data-index="{{ g.index }}"
		streams="{{ g.streams }}"
		dataurl="{{ dataurl }}"
		timezero="{{ timeZero }}"
		_draggable="true"
		on-dragover="{{ dragOverChart }}"
		on-dragenter="{{ dragEnterChart }}"
		on-dragleave="{{ dragLeaveChart }}"
		on-drop="{{ dropOnChart }}"
		on-remove-chart="{{ removeChart }}"
	>
	</octopus-chart-static>
	</template>
</experiment-data>

</template>
<script>

Polymer('octopus-experiment-viewer', {

	timeZero: 0,
	variables: [],
	dataurl: '',
	runtimeStreams: [],

	graphs: [],

	_itemIndex: 0,

	_dragEnterCount: 0,
	_dragSourceName: null,
	_dragSourceType: null,
	_dragSourceIndex: null,

	ready: function () {
		console.log("ready");
	},

	variableClicked: function (e) {
		if (e.srcElement.dataset.id) {
			var id = e.srcElement.dataset.id;

			// Find id in variables.
			for (var i = 0, m = this.variables.length; i < m; i++) {
				if (this.variables[i].key === id) {
					var variable = this.variables[i];
					this.graphs.push({
						index: this._itemIndex++,
						streams: [variable],
						unit: variable.unit
					});
					return;
				}
			}
		}
	},
	
	dragStart: function (e) {
		var id, arr, propName;

		if (e.target.tagName === "OCTOPUS-CHART-STATIC") {
			id = parseInt(e.target.dataset.index, 10);
			arr = this.graphs;
			propName = "index";

			this._dragSourceType = "chart";
			this._dragSourceName = id;

		} else {
			return;
		}

		for (var i = 0, m = arr.length; i < m; i++) {
			if (arr[i][propName] === id) {
				this._dragSourceIndex = i;
				break;
			}
		}

		// Set Dragging classes - NB due to chrome bug DOM modification
		// cannot be performed directly in dragStart.
		var target = e.target;
		var area = this.$.displayarea;
		window.setTimeout(function () {
			$(target).addClass("dragging");
			$(area).addClass("dragging");
		}, 0);
	},

	_targetAncestor: function (target, tag) {
		if (target.tagName.toLowerCase() === tag) {
			return $(target);
		} else {
			return $(target).parents(tag);
		}
	},

	dragEnd: function () {
		this._dragEnterCount = 0;
		$(".dragging", this.$.displayarea).removeClass("dragging");
		$(this.$.displayarea).removeClass("dragging");
		$("octopus-chart, octopus-property", this.$.displayarea).removeClass("over");

		this._dragSourceType = null;
		this._dragSourceName = null;
		this._dragSourceIndex = null;
	},

	_validOverChart: function (target) {
		if (!target) {
			return false;
		}
		if (this._dragSourceType === "chart") {
			return this.graphs[this._dragSourceIndex].unit === target.unit && $(target).data("index") !== this._dragSourceName;
		}
		return false;
	},

	dragOverChart: function (e) {
		var target = this._targetAncestor(e.target, "octopus-chart-static");

		if (this._validOverChart(target[0])) {
			e.dataTransfer.dropEffect = 'move'; 
			e.preventDefault();
			return;
		}

		if (this._dragEnterCount > 0) {
			e.dataTransfer.dropEffect = 'move'; 
			//console.log("over:", id, this._dragSourceName);
			e.preventDefault();
			return false;
		}
	},
	
	dragEnterChart: function (e) {
		var target = this._targetAncestor(e.target, "octopus-chart-static");

		if (!this._validOverChart(target[0])) {
			return;
		}

		if (this._dragEnterCount === 0) {
			$(target).addClass("over");
		}
		this._dragEnterCount++;
	},

	dragLeaveChart: function (e) {
		if (this._dragEnterCount > 0 && --this._dragEnterCount === 0) {
			var target = this._targetAncestor(e.target, "octopus-chart-static");
			$(target).removeClass("over");
		}
	},

	dropOnChart: function (e) {
		var target = this._targetAncestor(e.target, "octopus-chart-static");

		// Combine streams of source chart with target chart
		if (this._dragSourceType === "chart") {
			var index = parseInt(target.data("index"), 10);

			if (index === this._dragSourceName) {
				return;
			}

			var chart = this.graphs[this._dragSourceIndex];
			Array.prototype.push.apply(target[0].streams, chart.streams);
			this.graphs.splice(this._dragSourceIndex, 1);
		}

		this.dragEnd();
	},

	dragOverSlot: function (e) {
		var target = this._targetAncestor(e.target, "div");

		if (this._dragSourceType === "chart") {
			e.dataTransfer.dropEffect = 'move'; 
			e.preventDefault();
			return;
		}
	},

	dragEnterSlot: function (e) {
		var target = this._targetAncestor(e.target, "div");

		if (this._dragSourceType !== "chart") {
			return;
		}

		if (this._dragEnterCount === 0) {
			$(target).addClass("over");
		}
		this._dragEnterCount++;
	},

	dragLeaveSlot: function (e) {
		if (this._dragEnterCount > 0 && --this._dragEnterCount === 0) {
			var target = this._targetAncestor(e.target, "div");
			$(target).removeClass("over");
		}
	},

	dropOnSlot: function (e) {
		var i, m, index = parseInt(this._targetAncestor(e.target, "div").data("before"), 10);

		for (i = 0, m = this.graphs.length; i < m; i++) {
			if (this.graphs[i].index === index) {
				break;
			}
		}

		if (this._dragSourceType === "chart") {
			var chart = this.graphs.splice(this._dragSourceIndex, 1);
			this.graphs.splice(i, 0, chart[0]);
		}

		this.dragEnd();
	},

	removeChart: function (e) {
		var index = $(e.target).data("index");

		for (i = 0, m = this.graphs.length; i < m; i++) {
			if (this.graphs[i].index === index) {
				this.graphs.splice(i, 1);
				break;
			}
		}
	},
});

</script>
</polymer-element>
