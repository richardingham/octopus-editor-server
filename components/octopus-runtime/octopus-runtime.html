<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="octopus-runtime" attributes="url sketch">
<script>

Polymer('octopus-runtime', {
    publish: {
		experiment: {
			id: null,
			state: "ready"
		}
	},

	ready: function () {
		var self = this;
		var socket = new WebSocket(this.url, "octopus");

		socket.onopen = function () {
			console.log("Socket open");
			self.open = true;
			self.load(self.sketch)
		};

		socket.onmessage = function (e) {
			var data = JSON.parse(e.data);
			//console.log("socket message", data);

			var protocol = data.protocol;
			var command = data.command;
			var payload = data.payload;

			if (protocol === "sketch" && payload.sketch == self.sketch) {
				if (command === "sketch-load") {
					self.fire("sketch-loaded", payload);
				}

				if (command === "block-state") {
					self.fire("block-state", payload);
					console.log("Block", payload.block, "state", payload.state);
				}

				if (command === "experiment-started") {
					self.experiment.id = payload.experiment;
					self.experiment.state = "running";
				} else if (command === "experiment-stopped") {
					self.experiment.id = null;
					self.experiment.state = "ready";
				} else if (command === "experiment-paused") {
					self.experiment.state = "paused";
				} else if (command === "experiment-resumed") {
					self.experiment.state = "running";
				} else if (command === "experiment-error") {
					self.experiment.state = "error";
				} else if (command === "experiment-log" && payload.experiment == self.experiment) {
					console.log("experiment-log", "[", payload.level, "]", payload.message);
				}
			}
		};

		socket.onclose = function (reason) {
			console.log("Connection Closed: ", reason);
			self.open = false;
		};

		this.socket = socket;
	},

	blockEvent: function (event) {
		if (!this.open) {
			return;
		}

		event.data.sketch = this.sketch;

		var data = {
			protocol: "sketch",
			command: "block-" + event.eventType,
			payload: event.data
		};

		console.log("Socket send", data);
		this.socket.send(JSON.stringify(data));
	},

	experimentAction: function (action) {
		if (!this.open) {
			return;
		}

		var data = {
			protocol: "sketch",
			command: "experiment-" + action,
			payload: {
				sketch: this.sketch
			}
		};

		console.log("Socket send", data);
		this.socket.send(JSON.stringify(data));
	},
	
	load: function (id) {
		var data = {
			protocol: "sketch",
			command: "sketch-load",
			payload: {
				sketch: id
			}
		};

		console.log("Socket send", data);
		this.socket.send(JSON.stringify(data));
	}
});

</script>
</polymer-element>
