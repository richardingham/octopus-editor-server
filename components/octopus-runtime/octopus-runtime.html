<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="octopus-runtime" attributes="url sketch">
<script>

Polymer('octopus-runtime', {
    publish: {
		experiment: {
			id: null,
			state: "ready"
		}
	},

	ready: function () {
		var self = this;
		var socket = new WebSocket(this.url, "octopus");

		socket.onopen = function () {
			console.log("Socket open");
			self.open = true;
			self.load(self.sketch)
		};

		socket.onmessage = function (e) {
			var data = JSON.parse(e.data);
			//console.log("socket message", data);

			var protocol = data.protocol;
			var command = data.command;
			var payload = data.payload;

			if (protocol === "sketch" && payload.sketch == self.sketch) {
				if (command === "load") {
					if (payload.state !== "ready") {
						self.experiment.state = payload.state;
						self.experiment.id = payload.experiment;
					}

					var message, messages = payload['log-messages'] || [];
					for (var i = 0, m = messages.length; i < m; i++) {
						message = messages[i];
						self._fireLogMessage(message.experiment, message.level, message.message, new Date(message.time * 1000));
					}

					return self.fire("sketch-loaded", payload);
				} 

				if (command === "renamed") {
					return self.fire("title-renamed", payload.title);
				} 
			}
			
			if (protocol === "block" && payload.sketch == self.sketch) {
				return self.fire("block-changed", data);
			}

			if (protocol === "experiment" && payload.sketch == self.sketch) {
				if (command === "state-started") {
					self.experiment.id = payload.experiment;
					self.experiment.state = "running";
					self._fireLogMessage(payload.experiment, "status", "Experiment running", new Date());
				} else if (command === "state-stopped") {
					self.experiment.id = null;
					self.experiment.state = "ready";
					self._fireLogMessage(payload.experiment, "status", "Experiment complete", new Date());
				} else if (command === "state-paused") {
					self.experiment.state = "paused";
					self._fireLogMessage(payload.experiment, "status", "Experiment paused", new Date());
				} else if (command === "state-resumed") {
					self.experiment.state = "running";
					self._fireLogMessage(payload.experiment, "status", "Experiment resumed", new Date());
				} else if (command === "state-error") {
					self.experiment.state = "error";
					self._fireLogMessage(payload.experiment, "error", "Experiment error: " + payload.error, new Date());
				} 

				else if (command === "log" && payload.experiment == self.experiment.id) {
					self._fireLogMessage(payload.experiment, payload.level, payload.message, new Date(payload.time * 1000));
				}
			}

			if (command === "error" && payload.sketch == self.sketch) {
				console.error(protocol, payload);
			}
		};

		socket.onclose = function (reason) {
			console.log("Connection Closed: ", reason);
			alert("Connection to server was lost. Please refresh the page.");
			self.open = false;
		};

		this.socket = socket;
	},

	_fireLogMessage: function (experiment, level, message, time) {
		this.fire("experiment-log", { 
			experiment: experiment,
			level: level,
			message: message,
			time: time
		});
	},

	_socketSend: function (protocol, command, payload) {
		if (!this.open) {
			return;
		}

		var data = { protocol: protocol, command: command, payload: payload };

		console.log("Socket send", data);
		this.socket.send(JSON.stringify(data));
	},

	blockEvent: function (event) {
		event.data.sketch = this.sketch;

		// Remove "block-" from each event in a transaction.
		if (event.eventType === "transaction") {
			event.data.events = event.data.events.map(function (event) {
				if (event.event.substring(0, 6) === "block-") {
					event.event = event.event.substring(6);
				}
				return event;
			});
		}

		this._socketSend("block", event.eventType, event.data);
	},

	changeTitle: function (title) {
		this._socketSend("sketch", "rename", { 
			sketch: this.sketch, 
			title: title 
		});
	},

	experimentAction: function (action) {
		this._socketSend("experiment", action, {
			sketch: this.sketch
		});
	},

	load: function (id) {
		this._socketSend("sketch", "load", {
			sketch: id
		});
	}
});

</script>
</polymer-element>
